omigami-base:
  FROM: continuumio/miniconda3
  build: |
    ENV PATH="/opt/conda/bin/:${PATH}"
    WORKDIR /opt/omigami

    COPY ./docker /opt/omigami/docker
    RUN cat docker/spectra_matching.Dockerfile

  build_directory: .


omigami-ms2deepscore:
  requires:
    - omigami-base
  build: |
    WORKDIR /opt/ms2deepscore

    COPY ./docker /opt/ms2deepscore/docker
    RUN cat docker/ms2deepscore.Dockerfile

  build_directory: .


omigami-spec2vec:
  requires:
    - omigami-base
  build: |
    ENV PIP_DEFAULT_TIMEOUT=100
    WORKDIR /opt/spec2vec

    COPY ./omigami/spectra_matching/spec2vec/requirements /opt/spec2vec/requirements
    RUN cat requirements/environment.frozen.yaml | sed 's/omigami/base/g' > environment-docker.yml

    RUN /opt/conda/bin/conda env update --file environment-docker.yml \
        && /opt/conda/bin/conda clean -afy \
        && find /opt/conda/ -follow -type f -name '*.a' -delete \
        && find /opt/conda/ -follow -type f -name '*.pyc' -delete \
        && find /opt/conda/ -follow -type f -name '*.js.map' -delete

    COPY . /opt/spec2vec

  build_directory: .
